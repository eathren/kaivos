[gd_scene load_steps=4 format=3 uid="uid://cjccke53xingf"]

[ext_resource type="PackedScene" uid="uid://dfsbjqd8ea5ga" path="res://scenes/gameplay/enemies/imp.tscn" id="2_ribtj"]
[ext_resource type="Texture2D" uid="uid://q2rn4i5gtojj" path="res://assets/art/hell_portal.png" id="2_wheyl"]

[sub_resource type="GDScript" id="GDScript_wheyl"]
script/source = "extends Node2D

@export var imp_scene: PackedScene
@export var base_spawn_interval: float = 1.0  # Base spawn interval
@export var base_max_alive: int = 50  # Base max alive
@export var base_spawn_count_per_wave: int = 3  # Base spawn count per wave

var alive_from_this := 0
@onready var spawn_timer: Timer = $SpawnTimer

func _ready() -> void:
	if spawn_timer == null:
		push_error(\"SpawnTimer missing on HellPortal\")
		return
	_update_spawn_rates()
	spawn_timer.timeout.connect(_on_spawn_timeout)
	spawn_timer.start()
	add_to_group(\"hell_portals\")

func _update_spawn_rates() -> void:
	# Use GameState multiplier to scale spawn rates
	var multiplier := GameState.get_spawn_rate_multiplier()
	
	# Faster spawning = lower interval (divide by multiplier)
	var spawn_interval := base_spawn_interval / multiplier
	spawn_timer.wait_time = max(0.01, spawn_interval)  # Minimum 0.01s to prevent issues

func set_spawn_profile(profile: Dictionary) -> void:
	if profile.has(\"scene\"):
		imp_scene = profile[\"scene\"]
	if profile.has(\"interval\"):
		spawn_interval = profile[\"interval\"]
		if spawn_timer:
			spawn_timer.wait_time = spawn_interval
	if profile.has(\"max_alive\"):
		max_alive_from_this = profile[\"max_alive\"]

func _on_spawn_timeout() -> void:
	if imp_scene == null:
		return

	# Calculate spawn rates based on GameState multiplier
	var multiplier := GameState.get_spawn_rate_multiplier()
	var max_alive := int(base_max_alive * multiplier)
	var spawn_count := int(base_spawn_count_per_wave * multiplier)
	
	if alive_from_this >= max_alive:
		return

	# Spawn many imps at once based on multiplier
	var spawns_this_wave := min(spawn_count, max_alive - alive_from_this)
	
	for i in range(spawns_this_wave):
		# Use SpawnManager to spawn at valid locations (anywhere not a wall)
		var imp := SpawnManager.spawn(imp_scene)
		if imp == null:
			# Fallback: spawn at portal position if SpawnManager fails
			imp = imp_scene.instantiate()
			imp.global_position = global_position
			get_tree().current_scene.add_child(imp)
		
		alive_from_this += 1
		imp.tree_exited.connect(func() -> void:
			alive_from_this -= 1)
"

[node name="HellPortal" type="Node2D"]
script = SubResource("GDScript_wheyl")
imp_scene = ExtResource("2_ribtj")

[node name="Sprite2D" type="Sprite2D" parent="."]
texture = ExtResource("2_wheyl")

[node name="SpawnTimer" type="Timer" parent="."]
